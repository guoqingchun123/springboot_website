<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace = "com.bestvike.website.dao.ViewHouseInfoDao">
	<select id = "selectDivisions" resultType = "ViewDivisionInfo">
        <![CDATA[
		  SELECT t1.*, t2.region_num, t3.bld_num FROM view_divisionInfo t1
		  LEFT JOIN (SELECT COUNT(1) region_num, division_code FROM view_regioninfo GROUP BY division_code) t2
		  ON t1.division_code = t2.division_code
		  LEFT JOIN (SELECT COUNT(1) bld_num, division_code FROM view_regioninfo vr
		  	INNER JOIN ass_regbld ar on vr.region_id = ar.region_id
		  GROUP BY division_code) t3
		  ON t1.division_code = t3.division_code
        ]]>
    </select>

	<select id = "selectRegionBldList" parameterType = "String" resultType = "AssRegBld">
		<![CDATA[
			SELECT t.bld_id, t2.bld_name || '#',
			t.region_id FROM Ass_RegBld t LEFT JOIN View_BldInfo t2 on t.bld_id = t2.bld_id WHERE t.region_id = #{regionId}
		]]>
	</select>

	<select id = "selectRegionCellList" parameterType = "String" resultType = "com.bestvike.website.entity.RegionCell">
		<![CDATA[
			SELECT t.project_id, t.bld_no, t.cell_no, t1.bld_name || '#' || t.cell_name || '单元' cell_name
			FROM view_houseinfo t LEFT JOIN view_bldinfo t1 ON t.bld_no = t1.bld_no AND t.project_id = t1.project_id
			 WHERE t.project_id in (select a.project_id from ASS_REGBLD a where a.region_id = #{regionId})
			GROUP BY t.project_id, t.bld_no, t.cell_no, t1.bld_name, t.cell_name
			ORDER BY t.project_id, t.bld_no, t.cell_no, t1.bld_name, t.cell_name
		]]>
	</select>

	<select id = "selectHouseInfoList" parameterType = "map" resultType = "ViewHouseInfo">
		<![CDATA[
			SELECT t.*, row_number() over(partition by bld_no, cell_no, floor_no order by lpad(floor_no, 10, '0'), show_name, house_id) init_room,
				SUM(CASE WHEN t.presell_state = '已售' THEN 1 ELSE 0 END) over(partition BY bld_no, cell_no, floor_no) sale_num,
       			SUM(CASE WHEN t.presell_state = '未售' THEN 1 ELSE 0 END) over(partition BY bld_no, cell_no, floor_no) no_sale_Num,
       			SUM(1) over(partition BY bld_no, cell_no, floor_no) total_num
			FROM view_houseinfo t WHERE project_id = #{projectId} and bld_no = #{bldNo} and cell_no = #{cellNo}
			ORDER BY lpad(floor_no, 10, '0'), show_name, house_id
		]]>
	</select>

	<select id = "selectHouseByParameter" parameterType = "map" resultType = "com.bestvike.website.entity.House">
		<![CDATA[
			SELECT house_id, show_name, house_hold, house_use, floor_no, floor_name || '层' floor_name, construct_area,
				CASE WHEN mortgage_flag = '是' THEN '抵押'
					WHEN close_flag = '是' THEN '查封'
					WHEN frozen_flag = '是' THEN '冻结'
					WHEN presell_state = '已售' THEN '已售'
					WHEN sales_flag = '否' THEN '不予销售'
					WHEN presell_state = '未售' THEN '未售'
				ELSE '其他' END presell_state,
				CASE WHEN mortgage_flag = '是' THEN 'ddb400'
					WHEN close_flag = '是' THEN 'dd6600'
					WHEN frozen_flag = '是' THEN 'dd8800'
					WHEN presell_state = '已售' THEN 'dd6a62'
					WHEN sales_flag = '否' THEN '959595'
					WHEN presell_state = '未售' THEN '00dd02'
				ELSE '00dd02' END color_code,
				CASE WHEN presell_state = '已售' THEN 0 ELSE presell_price END presell_price
			FROM view_houseinfo
			WHERE project_id = #{projectId} AND bld_no = #{bldNo} AND cell_no = #{cellNo}
			ORDER BY case when regexp_replace(floor_no,'[-0-9,.]', '') IS NULL then to_number(floor_no) else 9999 end DESC,
			show_name ASC, house_id ASC
		]]>
	</select>

	<select id = "selectFloorSummary" parameterType = "map" resultType = "com.bestvike.website.entity.FloorSummary">
		<![CDATA[
			SELECT floor_no, floor_name || '层' floor_name, COUNT(1) total_num,
				sum(case when presell_state = '已售' then 1 else 0 END) saled_num,
				sum(case when presell_state = '未售' then 1 else 0 END) nosaled_num,
				sum(case when sales_flag != '是' then 1 else 0 END) nosale_num
			FROM view_houseinfo t
			WHERE t.project_id = #{projectId} AND t.bld_no = #{bldNo} AND t.cell_no = #{cellNo}
			GROUP BY floor_no, floor_name
			ORDER BY case when regexp_replace(floor_no,'[-0-9,.]', '') IS NULL then to_number(floor_no) else 9999 end DESC
		]]>
	</select>
</mapper>