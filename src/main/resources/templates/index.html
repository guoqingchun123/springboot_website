<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>赤峰市房产信息网</title>
	<link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}"/>
	<link th:href="@{/layui/css/layui.css}" rel="stylesheet" type="text/css">
	<script type="text/javascript"
			src="https://webapi.amap.com/maps?v=1.4.14&key=711b07f98b652cadccc69f4abd7ed455&plugin=AMap.Autocomplete,AMap.PlaceSearch,AMap.MarkerClusterer,AMap.ToolBar"></script>
	<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
	<div class="layui-header layui-bg-blue">
		<div class="layui-logo" style="color: white">赤峰市房产信息网</div>
	</div>
	<div class="layui-col-md9">
		<div id="container"></div>
	</div>
	<div class="layui-col-md3" style="overflow-y: auto">
		<div class="layui-btn-group sortBtnGroup" style="margin-top: 5px;">
			<button class="layui-btn layui-btn-sm" data-type="set" data-key="indicator" data-value="default" style="background-color: #5FB878;">默认</button>
			<button class="layui-btn layui-btn-sm" data-type="set" data-key="indicator" data-value="popularity">人气</button>
			<button class="layui-btn layui-btn-sm" data-type="set" data-key="indicator" data-value="price">售价</button>
		</div>
		<div class="layui-card" th:each="project : ${projects}">
			<div class="layui-card-header">
				<div style="float: left;">
					<label style="color: green;font-weight:bold" th:text="${project.projectname}"></label>&nbsp;&nbsp;
					¥<label style="color: red;font-weight:bold" th:text="${project.averageprice}"></label>
				</div>
				<div style="float: right">
					<button type="button" class="layui-btn layui-btn-primary summary-btn" th:value="${project.getProjectno()}">查看详情</button>
				</div>
			</div>
			<div class="layui-card-body">
				<img src="https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg">
				项目地址：<label th:text="${project.address}"></label>
			</div>
		</div>
	</div>
</div>
<script th:src="@{/layui/layui.js}"></script>
<script th:inline="javascript">
	layui.use(['carousel', 'element', "layer"], function () {
		var $ = layui.jquery;
		var layer = layui.layer;

		$("#container").height(window.innerHeight);
		$(".layui-col-md3").height(window.innerHeight);

		//创建地图
		var map = new AMap.Map('container', {
			center: [118.916202, 42.271235], //初始地图中心点
			resizeEnable: true, //是否监控地图容器尺寸变化
			zoom: 9,
			zooms: [8, 15]
		});

		var toolBar = new AMap.ToolBar({
			visible: true
		});
		toolBar.hideDirection();
		map.addControl(toolBar);
		$.get("/projects", {}, function (data) {
			layer.msg('共为您过滤出' + data.length + "个项目~~~");

			function initPage(DistrictCluster, PointSimplifier, $) {
				var pointSimplifierIns = new PointSimplifier({
					map: map, //所属的地图实例
					zIndex: 110,
					autoSetFitView: false, //禁止自动更新地图视野
					getPosition: function (item) {
						return item.position;
					},
					getHoverTitle: function (dataItem, idx) {
						return dataItem.dataItem.projectname + " 均价：" + dataItem.dataItem.averageprice;
					},
					renderOptions: {
						//点的样式
						pointStyle: {
							width: 6,
							height: 6,
							fillStyle: 'rgba(153, 0, 153, 0.38)'
						},
						//鼠标hover时的title信息
						hoverTitleStyle: {
							position: 'top'
						}
					}
				});

				var distCluster = new DistrictCluster({
					zIndex: 100,
					map: map, //所属的地图实例
					getPosition: function (item) {
						//返回经纬度
						return [item.xcoordinate, item.ycoordinate];
					},
					topAdcodes: [150400] //赤峰市
				});
				var currentAdcode = null;

				//监听区划面的点击
				distCluster.on('clusterMarkerClick', function (e, record) {
					currentAdcode = record.feature.properties.adcode;
					//获取该节点的聚合信息
					distCluster.getClusterRecord(currentAdcode, function (error, result) {
						//currentAdcode已经更新，有新的点击
						if (result.adcode !== currentAdcode) {
							return;
						}
						//设置数据
						//pointSimplifierIns.setData(result.dataItems);
						debugger
						for (var i = 0, marker; i < result.dataItems.length; i++) {
							var project = result.dataItems[i].dataItem;
							if (isNaN(project.xcoordinate) || isNaN(project.ycoordinate)) {
								continue;
							}
							marker = new AMap.Marker({
								icon: "/themes/images/poi-marker-default.png",
								position: [parseFloat(project.xcoordinate), parseFloat(project.ycoordinate)],
								offset: new AMap.Pixel(-13, -30)
							});
							marker.setMap(map);
							marker.content = "<div class=\"layui-card\">"
								+ "<div class=\"layui-card-header\">"
								+ project.projectname
								+ "</div>"
								+ "<div class=\"layui-card-body\">"
								+ "<img src=\"https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg\">"
								+ "</div>"
								+ "</div>";
							marker._id = project.projectno;
							marker.on('mouseover', markerOver);
							marker.on('click', markerClick);
						}
					})
				});

				//pointSimplifierIns.on('pointClick', markerClick);

				distCluster.on('renderFinish', function (e, result) {
					var features = result.features, //当前绘制的features
						currentAdcodeExists = false;
					for (var i = 0, len = features.length; i < len; i++) {
						if (currentAdcode === features[i].properties.adcode) {
							currentAdcodeExists = true;
							break;
						}
					}
					if (!currentAdcodeExists) {
						//如果当前adcode没有绘制，清除？
						//pointSimplifierIns.setData(null);
					}
				});
				window.distCluster = distCluster;

				function refresh() {
					var zoom = map.getZoom();
					//获取 pointStyle
					var pointStyle = pointSimplifierIns.getRenderOptions().pointStyle;
					//根据当前zoom调整点的尺寸
					pointStyle.width = pointStyle.height = 2 * Math.pow(1.2, map.getZoom() - 3);
				}

				map.on('zoomend', function () {
					refresh();
					// ajax
					console.info(map.getZoom());
					//在指定位置打开信息窗体
					//构建信息窗体中显示的内容
					var info = [];
					info.push("<div class='input-card content-window-card'><div><img style=\"float:left;\" src=\" https://webapi.amap.com/images/autonavi.png \"/></div> ");
					info.push("<div style=\"padding:7px 0px 0px 0px;\"><h4>高德软件</h4>");
					info.push("<p class='input-item'>电话 : 010-84107000   邮编 : 100102</p>");
					info.push("<p class='input-item'>地址 :北京市朝阳区望京阜荣街10号首开广场4层</p></div></div>");

					infoWindow = new AMap.InfoWindow({
						content: info.join("")  //使用默认信息窗体框样式，显示信息内容
					});

					infoWindow.open(map, map.getCenter());

				});
				refresh();

				$('<div id="loadingTip">加载数据，请稍候...</div>').appendTo(document.body);
				distCluster.setData(data);
				// $.get('https://a.amap.com/amap-ui/static/data/10w.txt', function (csv) {
				//
				// });
			}

			//加载相关组件
			AMapUI.load(['ui/geo/DistrictCluster', 'ui/misc/PointSimplifier', 'lib/$'], function (DistrictCluster, PointSimplifier, $) {
				//启动页面
				initPage(DistrictCluster, PointSimplifier, $);
			});
		});

		function markerClick(dataItem, number) {
			debugger
			// 用于页面传值
			layui.data('project', {
				key: 'projectno'
				, value: number.data.dataItem.projectno
			});
			layer.open({
				type: 2,
				title: "项目详情",
				area: ['90%', '900px'],
				maxmin: true,
				scrollbar: false,
				content: ['/content/' + number.data.dataItem.projectno, 'yes']
			});
		}

		$('.summary-btn').on('click', function () {
			var projectno = $(this).val();
			layui.data('project', {
				key: 'projectno'
				, value: projectno
			});
			layer.open({
				type: 2,
				title: "项目详情",
				area: ['90%', '900px'],
				maxmin: true,
				scrollbar: false,
				content: ['/content/' + projectno, 'yes']
			});
		});

		var active = {
			set: function (othis) {
				var THIS = 'layui-bg-normal'
					, key = othis.data('key')
					, options = {};

				othis.css('background-color', '#5FB878').siblings().removeAttr('style');
				options[key] = othis.data('value');
			}
		};

		$('.sortBtnGroup .layui-btn').on('click', function () {
			var othis = $(this), type = othis.data('type');
			active[type] ? active[type].call(this, othis) : '';
		});
	});
</script>
</body>
</html>