<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>赤峰市房产信息网</title>
	<link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}"/>
	<link th:href="@{/layui/css/layui.css}" rel="stylesheet" type="text/css">
	<script type="text/javascript"
			src="https://webapi.amap.com/maps?v=1.4.14&key=711b07f98b652cadccc69f4abd7ed455&plugin=AMap.ToolBar,AMap.DistrictSearch"></script>
	<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
	<style>
		.division {
			width: 120px;
			height: 20px;
			line-height: 20px;
			font-size: 12px;
			margin: 0 auto 10px;
			text-align: center;
			background-color: rgba(0, 167, 91, 0.9);
			cursor: pointer;
			color: #fff;
			border-radius: 10%;
		}
		
		.division:hover {
			background-color: red;
		}
	</style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
	<div class="layui-header layui-bg-blue">
		<div class="layui-logo" style="left: 15px">
			<img th:src="@{/themes/images/logo.png}">
		</div>
	</div>
	<div class="layui-col-md9">
		<div id="container"></div>
	</div>
	<div class="layui-col-md3" style="overflow-y: auto">
		<div class="layui-btn-group sortBtnGroup" style="margin-top: 5px;">
			<button class="layui-btn layui-btn-sm" data-type="set" data-key="indicator" data-value="default" style="background-color: #5FB878;">默认</button>
			<button class="layui-btn layui-btn-sm" data-type="set" data-key="indicator" data-value="popularity">人气</button>
			<button class="layui-btn layui-btn-sm" data-type="set" data-key="indicator" data-value="price">售价</button>
		</div>
		<div class="layui-card" th:each="project : ${projects}">
			<div class="layui-card-header">
				<div style="float: left;">
					<label style="color: green;font-weight:bold" th:text="${project.projectname}"></label>&nbsp;&nbsp;
					¥<label style="color: red;font-weight:bold" th:text="${project.averageprice}"></label>
				</div>
				<div style="float: right">
					<button type="button" class="layui-btn layui-btn-primary summary-btn" th:value="${project.getProjectno()}">查看详情</button>
				</div>
			</div>
			<div class="layui-card-body">
				<img src="https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg">
				项目地址：<label th:text="${project.address}"></label>
			</div>
		</div>
	</div>
</div>
<script th:src="@{/layui/layui.js}"></script>
<script th:inline="javascript">
	var ctxPath = /*[[@{/}]]*/'';
	var district = null;
	var polygons = [];

	layui.config({
		base: ctxPath + 'layui/autocomplete/'
	}).extend({ //设定模块别名
		autocomplete: 'autocomplete'
	});
	layui.use(['carousel', 'element', 'layer', 'autocomplete'], function () {
		var $ = layui.jquery;
		var layer = layui.layer;
		$("#container").height(window.innerHeight);
		$(".layui-col-md3").height(window.innerHeight);

		//创建地图
		var map = new AMap.Map('container', {
			center: [118.916202, 42.271235], //初始地图中心点
			resizeEnable: true, //是否监控地图容器尺寸变化
			zoom: 10,
			zooms: [10, 15]
		});

		map.on('zoomend', function () {
			// 地图缩放，刷新业务数据
			mapRefresh();
		});

		map.on('complete', function () {
			// 地图加载完成，刷新业务数据
			mapRefresh();
		});

		function mapRefresh() {
			var zoom = map.getZoom();
			if (zoom >= 14) { // 刷项目
				map.clearMap();
				// 获取项目加载点
				$.get(ctxPath + "projects", {}, function (data) {
					layer.msg('共为您过滤出' + data.length + "个项目~~~");
					for (var i = 0; i < data.length; i++) {
						var project = data[i];
						if (isNaN(project.xcoordinate) || isNaN(project.ycoordinate)) {
							continue;
						}
						if (project.xcoordinate == null || project.ycoordinate == null) {
							continue;
						}
						console.info(project);
						// 点标记显示内容，HTML要素字符串
						var markerContent =
							'<div class="division">' +
							'' + project.projectname
						'</div>';
						var marker = new AMap.Marker({
							position: [project.xcoordinate, project.ycoordinate],
							content: markerContent,
							// 以 icon 的 [center bottom] 为原点
							offset: new AMap.Pixel(-25, -27)
						});
						// 将 markers 添加到地图
						map.add(marker);
					}
				})
			} else if (zoom <= 13) { // 刷行政区
				map.clearMap();
				// 获取行政区加载点
				$.get(ctxPath + "divisions", {}, function (data) {
					layer.msg('共为您过滤出' + data.length + "个行政区~~~");
					for (var i = 0; i < data.length; i++) {
						var division = data[i];

						// 点标记显示内容，HTML要素字符串
						var markerContent =
							'<div class="division">' +
							'' + division.divisionName
							'</div>';
						var marker = new AMap.Marker({
							position: [division.x, division.y],
							content: markerContent,
							offset: new AMap.Pixel(-25, -27),
							extData: {
								division: division
							}
						});
						// 将 markers 添加到地图
						map.add(marker);
						// 给marker附焦点事件
						marker.on("mouseover", function () {
							divisionMousemove($(this)[0]);
						});
						// 给marker附焦点事件
						marker.on("mouseout", function () {
							map.remove(polygons); // 清除上次结果
							polygons = [];
						});
						// 给marker附点击事件
						marker.on("click", function () {
							map.setZoom(14);
							mapRefresh();
						});
					}
				})
			}
		}
		
		function divisionMousemove(marker) {
			var division = marker.getExtData().division;
			if (!district) {
				//实例化DistrictSearch
				var opts = {
					subdistrict: 0,   //获取边界不需要返回下级行政区
					extensions: 'all',  //返回行政区边界坐标组等具体信息
					level: 'district'  //查询行政级别为 市
				};
				district = new AMap.DistrictSearch(opts);
			}
			//行政区查询
			district.search(division.divisionName, function (status, result) {
				map.remove(polygons)//清除上次结果
				polygons = [];
				var bounds = result.districtList[0].boundaries;
				if (bounds) {
					for (var i = 0, l = bounds.length; i < l; i++) {
						//生成行政区划polygon
						var polygon = new AMap.Polygon({
							strokeWeight: 1,
							path: bounds[i],
							fillOpacity: 0.4,
							fillColor: '#18ff41',
							strokeColor: '#0bea9c'
						});
						polygons.push(polygon);
					}
				}
				map.add(polygons)
			});
		}
	});
</script>
</body>
</html>