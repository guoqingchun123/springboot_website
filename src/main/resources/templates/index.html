<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>赤峰市房产信息网</title>
	<link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}"/>
	<link th:href="@{/layui/css/layui.css}" rel="stylesheet" type="text/css">
	<link th:href="@{/layui/autocomplete/autocomplete.css}" rel="stylesheet" type="text/css">
	<script type="text/javascript"
			src="https://webapi.amap.com/maps?v=1.4.14&key=711b07f98b652cadccc69f4abd7ed455&plugin=AMap.ToolBar,AMap.DistrictSearch"></script>
	<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
	<style>
		.division {
			width: 84px;
			height: 84px;
			background-color: rgba(0, 167, 91, 0.9);
			border-radius: 50%;
			overflow: hidden;
			line-height: 20px;
			font-size: 12px;
			font-weight: 600;
			text-align: center;
			color: #fff;
			cursor: pointer;
			webkit-transition: background-color .15s ease-in-out;
			-moz-transition: background-color .15s ease-in-out;
			-o-transition: background-color .15s ease-in-out;
			transition: background-color .15s ease-in-out;
		}
		
		.division:hover {
			background-color: rgba(255, 0, 0, 0.9);
		}
		
		.division p {
			padding: 0 6px;
			margin: 0;
		}
		
		.division-title {
			margin: 10px 0 0 0 !important;
		}
		
		.project {
			line-height: 24px;
			cursor: pointer;
			color: #fff;
			font-size: 12px;
			font-weight: 600;
			text-align: center;
			display: inline-block;
		}
		
		.project-text {
			margin: 0;
			padding: 2px 10px;
			border-radius: 3px;
			background-color: rgba(0, 167, 91, 0.9);
			white-space: nowrap;
		}
		
		.project-jiantou {
			border: 5px solid transparent;
			display: block;
			width: 0;
			height: 0;
			margin: 0 auto;
			border-top-color: rgba(0, 167, 91, 0.9);
		}
		
		.project:hover .project-text {
			background-color: rgba(255, 0, 0, 0.9);
		}
		
		.project:hover .project-jiantou {
			border-top-color: rgba(255, 0, 0, 0.9);
		}
		
		.layui-input-search {
			width: 300px;
			margin: 10px;
		}
		
		.layui-icon-search {
			position: absolute;
			right: 30px;
			top: 18px;
			font-size: 24px;
			color: #1d211a;
		}
		
		.layui-form-autocomplete {
			color: #04cdff;
		}
	</style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
	<div class="layui-header layui-bg-blue">
		<div class="layui-col-md6" style="padding-left: 15px;padding-top: 15px">
			<img th:src="@{/themes/images/logo.png}">
		</div>
		<div class="layui-col-md6" style="padding-right: 15px;">
			<div style="float: right">
				<input type='text' autocomplete="off" placeholder="请输入项目名称或项目地址进行检索" class="layui-input layui-input-search" name="auto-projects" id="auto-projects">
				<a href=""><i class="layui-icon layui-icon-search"></i></a>
			</div>
		</div>
	</div>
	<div class="layui-col-md9">
		<div id="container"></div>
	</div>
	<div class="layui-col-md3 projects-card" style="overflow-y: auto">
		<div class="layui-btn-group sortBtnGroup" style="padding-top: 5px;">
			<button class="layui-btn" data-type="set" data-key="indicator" th:value="default" style="background-color: #5FB878;">默认</button>
			<button class="layui-btn" data-type="set" data-key="indicator" th:value="popularity">人气</button>
			<button class="layui-btn" data-type="set" data-key="indicator" th:value="price">售价</button>
		</div>
		<div id="projectCardView" style=""></div>
	</div>
	<div class="layui-col-md3 project-form" style="overflow-y: hidden">
		<div style="padding: 15px 15px 0 15px">
			<div class="layui-carousel" id="project-form-header">
				<div carousel-item>
				</div>
			</div>
			<fieldset class="layui-elem-field layui-field-title">
				<legend id="project-form-name"></legend>
			</fieldset>
			<div class="project-content"></div>
			<button type="button" class="layui-btn layui-btn-normal">查看详情</button>
			<button type="button" class="layui-btn layui-btn-primary layui-btn-back">返回</button>
		</div>
	</div>
</div>
<script id="projectCardScript" type="text/html">
	{{#  layui.each(d, function(index, item){ }}
	<div class="layui-card">
		<div class="layui-card-header">
			<div style="float: left;">
				<label style="color: green;font-weight:bold">{{item.projectName}}</label>&nbsp;&nbsp;
				¥<label style="color: red;font-weight:bold">{{item.avgPrice}}</label>
			</div>
			<div style="float: right">
				<button type="button" class="layui-btn layui-btn-primary summary-btn">查看详情</button>
			</div>
		</div>
		<div class="layui-card-body">
			<img src="https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg">
			项目地址：<label>{{item.address}}</label>
		</div>
	</div>
	{{#  }); }}
</script>

<script th:src="@{/layui/layui.js}"></script>
<script th:inline="javascript">
	var ctxPath = /*[[@{/}]]*/'';
	var district = null;
	var polygons = [];
	var infoWindow = null;

	var projects = [[${projects}]];

	layui.config({
		base: ctxPath + 'layui/autocomplete/'
	}).extend({ //设定模块别名
		autocomplete: 'autocomplete'
	});
	layui.use(['carousel', 'element', 'layer', 'autocomplete', 'laytpl'], function () {
		var $ = layui.jquery;
		var layer = layui.layer;
		var carousel = layui.carousel;
		var laytpl = layui.laytpl;

		var getTpl = document.getElementById("projectCardScript").innerHTML
			, view = document.getElementById('projectCardView');
		laytpl(getTpl).render(projects, function (html) {
			view.innerHTML = html;
		});

		$("#container").height(window.innerHeight - 60);
		$(".layui-col-md3").height(window.innerHeight - 60);

		var autocomplete = layui.autocomplete;

		// auto 快速定位，过滤小区
		autocomplete.render({
			elem: $('#auto-projects')[0],
			url: ctxPath + 'auto-projects',
			template_val: '{{d.projectName}}',
			template_txt: '{{d.projectName}} <span class=\'layui-badge layui-bg-gray\'>{{d.address}}</span>',
			onselect: function (resp) {
				map.setZoom("14"); //设置地图层级
				map.panTo([resp.x, resp.y]);
				// 刷新获取project详情数据
				$.get(ctxPath + "project/" + resp.projectId, {}, function (data) {
					projectShow(data);
				});
			}
		});

		//创建地图
		var map = new AMap.Map('container', {
			center: [118.916202, 42.271235], //初始地图中心点
			resizeEnable: true, //是否监控地图容器尺寸变化
			zoom: 10,
			zooms: [10, 15]
		});

		var toolBar = new AMap.ToolBar({
			visible: true
		});
		toolBar.hideDirection();
		map.addControl(toolBar);

		map.on('zoomend', function () {
			// 地图缩放，刷新业务数据
			mapRefresh();
		});

		map.on('complete', function () {
			// 地图加载完成，刷新业务数据
			mapRefresh();
		});

		function mapRefresh() {
			var zoom = map.getZoom();
			if (zoom >= 14) { // 刷项目
				map.clearMap();
				// 获取项目加载点
				$.get(ctxPath + "projects", {}, function (data) {
					layer.msg('共为您过滤出' + data.length + "个项目~~~");
					for (var i = 0; i < data.length; i++) {
						var project = data[i];
						if (isNaN(project.x) || isNaN(project.y)) {
							continue;
						}
						if (project.x == null || project.y == null) {
							continue;
						}
						// 点标记显示内容，HTML要素字符串
						var markerContent =
							'<div class="project" id="' + project.projectId + 'Div">'
							+ '<p class="project-text">' + project.projectName + '&nbsp;' + project.avgPrice + '元</p>'
							+ '<i class="project-jiantou"></i>'
							+ '</div>';
						var marker = new AMap.Marker({
							position: [project.x, project.y],
							content: markerContent,
							// 以 icon 的 [center bottom] 为原点
							offset: new AMap.Pixel(0, -27),
							extData: {
								id: project.projectId,
								project: project
							}
						});
						// 将 markers 添加到地图
						map.add(marker);
						// 鼠标滑过marker浮在最上层
						marker.on("mouseover", function () {
							$(".amap-marker").css("z-index", "100");
							var project = $(this)[0].getExtData().project;
							$("#" + project.projectId + "Div").parents(".amap-marker").css("z-index", "101");
							// 添加infowindow项目简介
							var content = "<div class=\"layui-card\">"
								+ "<div class=\"layui-card-header\">"
								+ project.projectName
								+ "<label color='red'>" + project.avgPrice + "起</label>"
								+ "</div>"
								+ "<div class=\"layui-card-body\">"
								+ "<img src=\"https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg\">"
								+ "</div>"
								+ "</div>";
							infoWindow = new AMap.InfoWindow({
								content: content,  //使用默认信息窗体框样式，显示信息内容
								offset: new AMap.Pixel(50, -27)
							});
							infoWindow.open(map, [project.x, project.y]);
						});
						marker.on("mouseout", function () {
							if (infoWindow) {
								infoWindow.close();
							}
						});
						// 给marker附点击事件
						marker.on("click", function () {
							var project = $(this)[0].getExtData().project;
							// 刷新获取project详情数据
							$.get(ctxPath + "project/" + project.projectId, {}, function (data) {
								projectShow(data);
							});
						});
					}
				})
			} else if (zoom <= 13) { // 刷行政区
				map.clearMap();
				// 获取行政区加载点
				$.get(ctxPath + "divisions", {}, function (data) {
					layer.msg('共为您过滤出' + data.length + "个行政区~~~");
					for (var i = 0; i < data.length; i++) {
						var division = data[i];

						// 点标记显示内容，HTML要素字符串
						var markerContent =
							'<div class="division">'
							+ '<p class="division-title">' + division.divisionName + '</p>'
							+ '<p>' + division.avgPrice + '元</p>'
							+ '<p>' + division.houseNum + '套</p>'
							+ '</div>';
						var marker = new AMap.Marker({
							position: [division.x, division.y],
							content: markerContent,
							offset: new AMap.Pixel(0, 0),
							extData: {
								division: division
							}
						});
						// 将 markers 添加到地图
						map.add(marker);
						// 给marker附焦点事件
						marker.on("mouseover", function () {
							divisionMousemove($(this)[0]);
						});
						// 给marker附焦点事件
						marker.on("mouseout", function () {
							map.remove(polygons); // 清除上次结果
							polygons = [];
						});
						// 给marker附点击事件
						marker.on("click", function () {
							map.setZoom(14);
							mapRefresh();
						});
					}
				})
			}
		}

		function divisionMousemove(marker) {
			var division = marker.getExtData().division;
			if (!district) {
				//实例化DistrictSearch
				var opts = {
					subdistrict: 0,   //获取边界不需要返回下级行政区
					extensions: 'all',  //返回行政区边界坐标组等具体信息
					level: 'district'  //查询行政级别为 市
				};
				district = new AMap.DistrictSearch(opts);
			}
			//行政区查询
			district.search(division.divisionName, function (status, result) {
				map.remove(polygons)//清除上次结果
				polygons = [];
				var bounds = result.districtList[0].boundaries;
				if (bounds) {
					for (var i = 0, l = bounds.length; i < l; i++) {
						//生成行政区划polygon
						var polygon = new AMap.Polygon({
							strokeWeight: 1,
							path: bounds[i],
							fillOpacity: 0.4,
							fillColor: '#18ff41',
							strokeColor: '#0bea9c'
						});
						polygons.push(polygon);
					}
				}
				map.add(polygons)
			});
		}

		function projectShow(project) {
			$(".projects-card").hide();
			var options = {
				elem: '#project-form-header',
				width: '100%', //设置容器宽度
				height: '200px',
				arrow: 'always', //始终显示箭头
				autoplay: true
			};
			var ins = carousel.render(options);
			$("#project-form-header").children("div").html('<img src="https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg">'
				+ '<img src="https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg">'
				+ '<img src="https://pic4.ajkimg.com/display/xinfang/665944b5b39a56537506838714c4e8b4/129x115n.jpg">');
			ins.reload(options);
			$("#project-form-name").html(project.projectName);

			$(".project-content").html(
				'<p class="layui-elem-quote">开发企业：' + project.developerName + '</p>'
				+ '<p class="layui-elem-quote">项目坐落：' + project.address + '</p>'
				+ '<p class="layui-elem-quote">销售均价：' + project.avgPrice + '元/㎡</p>'
				+ '<p class="layui-elem-quote">价格区间：' + project.minPrice + '-' + project.maxPrice + '元/㎡</p>'
				+ '<p class="layui-elem-quote">楼栋数：' + project.bldNum + '</p>'
				+ '<p class="layui-elem-quote">绿化率：' + project.greeningRate + '</p>'
			);

			$(".project-form").show();

			// 跳转到新页面
			$(".layui-btn-normal").on("click", function () {
				window.open(ctxPath + 'content/' + project.projectId, '_blank');
			});
		}

		var active = {
			set: function (othis) {
				var THIS = 'layui-bg-normal'
					, key = othis.data('key')
					, options = {};

				othis.css('background-color', '#5FB878').siblings().removeAttr('style');
				options[key] = othis.data('value');
			}
		};

		$('.sortBtnGroup .layui-btn').on('click', function () {
			var othis = $(this), type = othis.data('type');
			active[type] ? active[type].call(this, othis) : '';
			$.get(ctxPath + "projects?order=" + othis.val(), {}, function (data) {
				laytpl(getTpl).render(data, function (html) {
					view.innerHTML = html;
				});
			});
		});

		$('.summary-btn').on('click', function () {
			var projectId = $(this).val();
			window.open(ctxPath + 'content/' + projectId, '_blank');
		});

		$(".layui-btn-back").on('click', function () {
			$(".projects-card").show();
			$(".project-form").hide();
		});
	});
</script>
</body>
</html>